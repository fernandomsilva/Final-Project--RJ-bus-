  
<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Interactive Neighborhood</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
	<script src="new_points.js"></script>
	<script src="bus_density.js"></script>
	<script src="RainbowVis.js"></script>
	<script src="underscore.js"></script>
	<script src="bus_lines_per_neighborhood.js"></script>
    <script>

var gradient_min_color = 'yellow';
var gradient_max_color = 'red';
	
var map;

var neighborhoods = new Array();
var train_subway_markers = new Array();
train_subway_markers["train"] = new Array();
train_subway_markers["subway"] = new Array();
var train_markers_visible = false;
var subway_markers_visible = false;

var rainbow = new Rainbow();

rainbow.setNumberRange(min_density, max_density);
rainbow.setSpectrum(gradient_min_color, gradient_max_color);

var selected_neighborhoods = new Array();
var active_neighborhoods = new Array();
var active_bus_lines = new Array();
var old_selected_neighthoods_length = 0;

function WithoutMaxControl(controlDiv, map) {
	controlDiv.style.padding = '5px';

	var controlUI = document.createElement('div');
	controlUI.style.backgroundColor = 'white';
	controlUI.style.borderStyle = 'solid';
	controlUI.style.borderWidth = '2px';
	controlUI.style.cursor = 'pointer';
	controlUI.style.textAlign = 'center';
	controlUI.title = 'Click to set the heat map without the max';
	controlDiv.appendChild(controlUI);

	var controlText = document.createElement('div');
	controlText.style.fontFamily = 'Arial,sans-serif';
	controlText.style.fontSize = '12px';
	controlText.style.paddingLeft = '4px';
	controlText.style.paddingRight = '4px';
	controlText.innerHTML = '<b>noMAX</b>';
	controlUI.appendChild(controlText);

	google.maps.event.addDomListener(controlUI, 'click', function() {
		clearSelections();
		
		rainbow.setNumberRange(min_density, second_max_density);
		rainbow.setSpectrum(gradient_min_color, gradient_max_color);
		
		changePolygonColor();
	});

}

function WithMaxControl(controlDiv, map) {
	controlDiv.style.padding = '5px';

	var controlUI = document.createElement('div');
	controlUI.style.backgroundColor = 'white';
	controlUI.style.borderStyle = 'solid';
	controlUI.style.borderWidth = '2px';
	controlUI.style.cursor = 'pointer';
	controlUI.style.textAlign = 'center';
	controlUI.title = 'Click to draw the heat map with the max';
	controlDiv.appendChild(controlUI);

	var controlText = document.createElement('div');
	controlText.style.fontFamily = 'Arial,sans-serif';
	controlText.style.fontSize = '12px';
	controlText.style.paddingLeft = '4px';
	controlText.style.paddingRight = '4px';
	controlText.innerHTML = '<b>MAX</b>';
	controlUI.appendChild(controlText);

	google.maps.event.addDomListener(controlUI, 'click', function() {
		clearSelections();
		
		rainbow.setNumberRange(min_density, max_density);
		rainbow.setSpectrum(gradient_min_color, gradient_max_color);
		
		changePolygonColor();
	});
}

function TrainControl(controlDiv, map) {
	controlDiv.style.padding = '5px';

	var controlUI = document.createElement('div');
	controlUI.style.backgroundColor = 'white';
	controlUI.style.borderStyle = 'solid';
	controlUI.style.borderWidth = '2px';
	controlUI.style.cursor = 'pointer';
	controlUI.style.textAlign = 'center';
	controlUI.title = 'Click to show the train stops';
	controlDiv.appendChild(controlUI);

	var controlText = document.createElement('div');
	controlText.style.fontFamily = 'Arial,sans-serif';
	controlText.style.fontSize = '12px';
	controlText.style.paddingLeft = '4px';
	controlText.style.paddingRight = '4px';
	controlText.innerHTML = '<b>Train</b>';
	controlUI.appendChild(controlText);

	google.maps.event.addDomListener(controlUI, 'click', function() {
		var j;
		train_markers_visible = !train_markers_visible;
		
		if (train_markers_visible)
		{
			for (j=0; j<Object.keys(train_subway_points['train']).length; j++)
			{
				train_subway_markers['train'][j].setMap(map);
			}
		}
		else
		{
			for (j=0; j<Object.keys(train_subway_points['train']).length; j++)
			{
				train_subway_markers['train'][j].setMap(null);
			}
		}
	});
}

function SubwayControl(controlDiv, map) {
	controlDiv.style.padding = '5px';

	var controlUI = document.createElement('div');
	controlUI.style.backgroundColor = 'white';
	controlUI.style.borderStyle = 'solid';
	controlUI.style.borderWidth = '2px';
	controlUI.style.cursor = 'pointer';
	controlUI.style.textAlign = 'center';
	controlUI.title = 'Click to show the subway stops';
	controlDiv.appendChild(controlUI);

	var controlText = document.createElement('div');
	controlText.style.fontFamily = 'Arial,sans-serif';
	controlText.style.fontSize = '12px';
	controlText.style.paddingLeft = '4px';
	controlText.style.paddingRight = '4px';
	controlText.innerHTML = '<b>Subway</b>';
	controlUI.appendChild(controlText);

	google.maps.event.addDomListener(controlUI, 'click', function() {
		var j;
		subway_markers_visible = !subway_markers_visible;
		
		if (subway_markers_visible)
		{
			for (j=0; j<Object.keys(train_subway_points['subway']).length; j++)
			{
				train_subway_markers['subway'][j].setMap(map);
			}
		}
		else
		{
			for (j=0; j<Object.keys(train_subway_points['subway']).length; j++)
			{
				train_subway_markers['subway'][j].setMap(null);
			}
		}
	});
}

var addListenersOnPolygon = function(polygon) {
	google.maps.event.addListener(polygon, 'click', function (event) {
		if (_.contains(active_neighborhoods, polygon.neighborhoodID) && !(_.contains(selected_neighborhoods, polygon.neighborhoodID)))
		{
			polygon.setOptions({fillColor: 'green', strokeColor: 'green'});
			selected_neighborhoods.push(polygon.neighborhoodID);
			calculatePolygonBusConnection();
		}
	});
	google.maps.event.addListener(polygon, 'rightclick', function (event) {
		if (_.contains(selected_neighborhoods, polygon.neighborhoodID))
		{
			var index = selected_neighborhoods.indexOf(polygon.neighborhoodID);
			
			if (index > -1)
			{
				selected_neighborhoods.splice(index, 1);
				calculatePolygonBusConnection();
			}
		}
	});
}

function drawPolygons()
{
	var temp = new Array();
	var color;
	var i = 0;

	for (key in points)
	{
		for (i = 0; i < Object.keys(points[key]).length; i++)
		{
			temp[i] = new google.maps.LatLng(points[key][i][0], points[key][i][1]);
		}

		if (typeof density[key] === 'undefined')
		{
			color = "black";
		}
		else
		{
			if (density[key] > rainbow.maxNum)
			{
				color = "black";
			}
			else
			{
				color = "#" + rainbow.colourAt(density[key]);
			}
		}
		neighborhoods[key] = new google.maps.Polygon({
			path: temp,
			geodesic: true,
			strokeColor: color,
			strokeOpacity: 1.0,
			strokeWeight: 2,
			fillColor: color,
			fillOpacity: 0.8,
			neighborhoodID: key
		});		
		neighborhoods[key].setMap(map);
		addListenersOnPolygon(neighborhoods[key]);
		temp.length = 0;
	}
}

function changePolygonColor()
{
	var color;

	for (key in neighborhoods)
	{
		if (typeof density[key] === 'undefined')
		{
			color = "black";
		}
		else
		{
			if (density[key] > rainbow.maxNum)
			{
				color = "black";
			}
			else
			{
				color = "#" + rainbow.colourAt(density[key]);
			}
		}
		
		neighborhoods[key].setOptions({strokeColor: color, fillColor: color});
	}
}

function changePolygonColor()
{
	var color;

	for (key in neighborhoods)
	{
		if (typeof density[key] === 'undefined')
		{
			color = "black";
		}
		else
		{
			if (density[key] > rainbow.maxNum)
			{
				color = "black";
			}
			else
			{
				color = "#" + rainbow.colourAt(density[key]);
			}
		}
		
		neighborhoods[key].setOptions({strokeColor: color, fillColor: color});
	}
}

function calculatePolygonBusConnection()
{
	var j, k;
	var temp = new Array();

	if (selected_neighborhoods.length > old_selected_neighthoods_length)
	{
		if (active_bus_lines.length == 0)
		{
			for (j=0; j<lines[selected_neighborhoods[selected_neighborhoods.length - 1]].length; j++)
			{
				active_bus_lines.push(lines[selected_neighborhoods[selected_neighborhoods.length - 1]][j]);
			}
		}
		else
		{
			k = 0;
			for (j=0; j<lines[selected_neighborhoods[selected_neighborhoods.length - 1]].length; j++)
			{
				if (_.contains(active_bus_lines, lines[selected_neighborhoods[selected_neighborhoods.length - 1]][j]))
				{
					temp[k] = lines[selected_neighborhoods[selected_neighborhoods.length - 1]][j];
					k = k + 1;
				}
			}
			
			active_bus_lines = temp;
		}
	}
	else
	{
		temp = new Array();
		k = 0;
		for (j=0; j<selected_neighborhoods.length; j++)
		{
			temp[j] = new Array();
			temp[j] = lines[selected_neighborhoods[j]];
		}
		if (temp.length > 1)
		{
			//console.log('1');
			//active_bus_lines = _.intersection(temp);
			active_bus_lines = temp[0]
			for (j=1; j<temp.length; j++)
			{
				active_bus_lines = _.intersection(active_bus_lines, temp[j]);
			}
		}
		else
		{
			active_bus_lines = temp[0];
		}
		
		temp.length = 0;
	}

	temp = new Array();
	
//	for (j=0; j<active_neighborhoods.length; j++)
	for (key in lines)
	{
		//for (k=0; k<lines[active_neighborhoods[j]].length; k++)
		for (k=0; k<lines[key].length; k++)
		{
			//if (_.contains(active_bus_lines, lines[active_neighborhoods[j]][k]))
			if (_.contains(active_bus_lines, lines[key][k]))
			{
				//temp.push(active_neighborhoods[j]);
				temp.push(key);
				break;
			}
		}
	}
	active_neighborhoods = temp;
	
	old_selected_neighthoods_length = selected_neighborhoods.length;
	updateNeighborhoodColors();
}

function updateNeighborhoodColors()
{
	if (selected_neighborhoods.length == 0)
	{
		active_bus_lines = new Array();
		for (key in lines)
		{
			active_neighborhoods.push(key);
		}
		
		changePolygonColor();
	}
	else
	{
		for (key in neighborhoods)
		{
			if ((_.contains(active_neighborhoods, key)) && !(_.contains(selected_neighborhoods, key)))
			{
				neighborhoods[key].setOptions({strokeColor: 'purple', fillColor: 'purple'});
			}
			else if (!(_.contains(active_neighborhoods, key)) && !(_.contains(selected_neighborhoods, key)))
			{
				neighborhoods[key].setOptions({strokeColor: 'black', fillColor: 'black'});
			}
			
			//fOpacity = 0.8;
		}
	}
}

function clearSelections()
{
	for (key in lines)
	{
		active_neighborhoods.push(key);
	}
	
	selected_neighborhoods = new Array();
	active_bus_lines = new Array();
}

function initialize() {
  // Create the map.

	var mapOptions = {
		zoom: 11,
		center: new google.maps.LatLng(map_center[0], map_center[1]),
		mapTypeId: google.maps.MapTypeId.TERRAIN
	};

	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	
	var ButtonsControlDiv = document.createElement('div');
	var NoMaxControl = new WithoutMaxControl(ButtonsControlDiv, map);
	var MaxControl = new WithMaxControl(ButtonsControlDiv, map);
	var TrainMarkersControle = new TrainControl(ButtonsControlDiv, map);
	var SubwayMarkersControle = new SubwayControl(ButtonsControlDiv, map);
	
	ButtonsControlDiv.index = 1;
	map.controls[google.maps.ControlPosition.TOP_RIGHT].push(ButtonsControlDiv);
	
	drawPolygons();
	
	var j;
	for (j=0; j<Object.keys(train_subway_points['train']).length; j++)
	{
		train_subway_markers['train'][j] =  new google.maps.Marker({
			position: new google.maps.LatLng(train_subway_points['train'][j][0],train_subway_points['train'][j][1]),
			icon: "http://mapicons.nicolasmollet.com/wp-content/uploads/mapicons/shape-default/color-509c50/shapecolor-color/shadow-1/border-dark/symbolstyle-contrast/symbolshadowstyle-dark/gradient-iphone/train.png",
			title: 'Train'
		});
	}
	for (j=0; j<Object.keys(train_subway_points['subway']).length; j++)
	{
		train_subway_markers['subway'][j] =  new google.maps.Marker({
			position: new google.maps.LatLng(train_subway_points['subway'][j][0],train_subway_points['subway'][j][1]),
			icon: "http://mapicons.nicolasmollet.com/wp-content/uploads/mapicons/shape-default/color-51559c/shapecolor-dark/shadow-1/border-white/symbolstyle-white/symbolshadowstyle-no/gradient-no/underground.png",
			title: 'Subway'
		});
	}
	
	for (key in lines)
	{
		active_neighborhoods.push(key);
	}
	
	infowindow = new google.maps.InfoWindow({
		content: ''
	});	
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>